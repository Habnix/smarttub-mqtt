services:
  smarttub-mqtt:
    # Use Docker Hub image (v0.3.1)
    # build: .
    image: willnix/smarttub-mqtt:latest
    container_name: smarttub-mqtt
    # Temporarily disabled to avoid rate limiting during testing
    # restart: unless-stopped
    
    # Mount config directory containing .env
    volumes:
      - ./config:/config
      - ./logs:/logs
    
    # Expose Web UI port
    ports:
      - "8080:8080"
    
    # Load environment from .env file in config directory
    env_file:
      - ./config/.env
    
    environment:
      - PYTHONUNBUFFERED=1
      
      # Background Discovery (v0.3.0)
      # Controls automatic discovery at startup
      # Options: off (default), startup_quick, startup_full, startup_yaml
      # - off: Manual discovery only via WebUI or MQTT
      # - startup_quick: Quick discovery (~5 min) on startup
      # - startup_full: Full discovery (~20 min) on startup
      # - startup_yaml: Load saved results only (instant)
      # Uncomment to enable:
      # - DISCOVERY_MODE=startup_quick
    
    # Network configuration
    network_mode: bridge
    
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Uncomment to add local MQTT broker
#  mosquitto:
#    image: eclipse-mosquitto:latest
#    container_name: mosquitto
#    restart: unless-stopped
#    ports:
#      - "1883:1883"
#      - "9001:9001"
#    volumes:
#      - ./mosquitto/config:/mosquitto/config
#      - ./mosquitto/data:/mosquitto/data
#      - ./mosquitto/log:/mosquitto/log

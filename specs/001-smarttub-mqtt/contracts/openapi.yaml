openapi: 3.1.0
info:
  title: SmartTub MQTT Bridge API
  version: 0.1.0
  description: REST endpoints backing the SmartTub MQTT Web UI and integrations.
servers:
  - url: http://localhost:8080
paths:
  /api/state:
    get:
      summary: Retrieve current whirlpool component state snapshot.
      operationId: getStateSnapshot
      responses:
        '200':
          description: Current component states.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StateSnapshot'
  /api/capabilities:
    get:
      summary: Retrieve detected whirlpool capabilities and available controls.
      operationId: getCapabilities
      responses:
        '200':
          description: Available components and supported commands.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilityProfile'
  /api/commands:
    post:
      summary: Issue a control command to the whirlpool.
      operationId: postCommand
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
      responses:
        '202':
          description: Command accepted and queued for execution.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
        '400':
          description: Invalid command or parameters.
        '409':
          description: Command conflicts with current state or capability.
  /api/logs:
    get:
      summary: Stream recent log events for monitoring.
      operationId: getLogs
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 500
      responses:
        '200':
          description: Recent log events.
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/LogEvent'
components:
  schemas:
    WhirlpoolComponent:
      type: object
      required: [id, name, type, state]
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [HEATER, PUMP, LIGHT, FILTER, SENSOR, OTHER]
        state:
          oneOf:
            - type: string
            - type: number
        attributes:
          type: object
          additionalProperties: true
        allowedCommands:
          type: array
          items:
            type: string
    StateSnapshot:
      type: object
      required: [timestamp, components]
      properties:
        timestamp:
          type: string
          format: date-time
        source:
          type: string
          enum: [SMARTTUB_POLL, COMMAND_CONFIRMATION, RECOVERY_SYNC]
        components:
          type: array
          items:
            $ref: '#/components/schemas/WhirlpoolComponent'
    CapabilityProfile:
      type: object
      required: [tubId, supportedComponents, commandMatrix]
      properties:
        tubId:
          type: string
        firmwareVersion:
          type: string
        lastDiscoveredAt:
          type: string
          format: date-time
        supportedComponents:
          type: array
          items:
            type: string
        commandMatrix:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
    CommandRequest:
      type: object
      required: [componentId, action]
      properties:
        componentId:
          type: string
        action:
          type: string
        parameters:
          type: object
          additionalProperties: true
    CommandResponse:
      type: object
      required: [commandId, status]
      properties:
        commandId:
          type: string
        status:
          type: string
          enum: [PENDING, SENT]
        message:
          type: string
    LogEvent:
      type: object
      required: [timestamp, level, message, source]
      properties:
        timestamp:
          type: string
          format: date-time
        level:
          type: string
          enum: [DEBUG, INFO, WARNING, ERROR]
        source:
          type: string
        message:
          type: string
        context:
          type: object
          additionalProperties: true

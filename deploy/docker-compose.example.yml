# Docker Compose Example for SmartTub-MQTT + OpenHAB Integration
#
# This compose file provides a complete stack for running SmartTub-MQTT
# alongside OpenHAB and an MQTT broker (Mosquitto).
#
# Usage:
#   1. Copy this file to docker-compose.yml
#   2. Copy .env.example to .env and fill in your credentials
#   3. Run: docker-compose up -d
#
# Services:
#   - mosquitto: MQTT broker (Eclipse Mosquitto)
#   - smarttub-mqtt: SmartTub bridge (this project)
#   - openhab: OpenHAB home automation (optional)

version: '3.8'

services:
  # ============================================================================
  # MQTT Broker - Eclipse Mosquitto
  # ============================================================================
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"    # MQTT
      - "9001:9001"    # WebSocket
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - smarttub-net
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================================================
  # SmartTub-MQTT Bridge
  # ============================================================================
  smarttub-mqtt:
    image: smarttub-mqtt:latest
    container_name: smarttub-mqtt
    restart: unless-stopped
    depends_on:
      mosquitto:
        condition: service_healthy
    ports:
      - "8080:8080"    # Web UI
    environment:
      # SmartTub API Credentials (from .env file)
      SMARTTUB_EMAIL: ${SMARTTUB_EMAIL}
      SMARTTUB_PASSWORD: ${SMARTTUB_PASSWORD:-}
      SMARTTUB_TOKEN: ${SMARTTUB_TOKEN:-}
      
      # MQTT Configuration
      MQTT_BROKER: mqtt://mosquitto:1883
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
      MQTT_BASE_TOPIC: ${MQTT_BASE_TOPIC:-smarttub-mqtt}
      MQTT_QOS: ${MQTT_QOS:-1}
      
      # SmartTub API Settings
      SMARTTUB_POLLING_INTERVAL: ${SMARTTUB_POLLING_INTERVAL:-30}
      SMARTTUB_TIMEOUT: ${SMARTTUB_TIMEOUT:-10}
      SMARTTUB_RETRIES: ${SMARTTUB_RETRIES:-3}
      
      # Discovery Settings
      CHECK_SMARTTUB: ${CHECK_SMARTTUB:-false}
      DISCOVERY_REFRESH_INTERVAL: ${DISCOVERY_REFRESH_INTERVAL:-86400}
      
      # Web UI Configuration
      WEB_ENABLED: ${WEB_ENABLED:-true}
      WEB_HOST: ${WEB_HOST:-0.0.0.0}
      WEB_PORT: ${WEB_PORT:-8080}
      WEB_AUTH_ENABLED: ${WEB_AUTH_ENABLED:-false}
      WEB_BASIC_AUTH_USERNAME: ${WEB_BASIC_AUTH_USERNAME:-}
      WEB_BASIC_AUTH_PASSWORD: ${WEB_BASIC_AUTH_PASSWORD:-}
      
      # Logging Configuration
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_DIR: /log
      LOG_MAX_SIZE_MB: ${LOG_MAX_SIZE_MB:-5}
      LOG_MAX_FILES: ${LOG_MAX_FILES:-1}
      LOG_COMPRESS: ${LOG_COMPRESS:-true}
      
      # Paths
      CONFIG_PATH: /config/smarttub.yaml
    volumes:
      - ./smarttub-mqtt/config:/config
      - ./smarttub-mqtt/log:/log
    networks:
      - smarttub-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8080/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # OpenHAB - Home Automation Platform (Optional)
  # ============================================================================
  openhab:
    image: openhab/openhab:4.1.0
    container_name: openhab
    restart: unless-stopped
    depends_on:
      - mosquitto
      - smarttub-mqtt
    ports:
      - "8181:8080"    # Web UI (mapped to avoid conflict with smarttub-mqtt)
      - "8443:8443"    # HTTPS
    environment:
      OPENHAB_HTTP_PORT: 8080
      OPENHAB_HTTPS_PORT: 8443
      EXTRA_JAVA_OPTS: "-Duser.timezone=${TZ:-Europe/Berlin}"
      CRYPTO_POLICY: unlimited
    volumes:
      - ./openhab/conf:/openhab/conf
      - ./openhab/userdata:/openhab/userdata
      - ./openhab/addons:/openhab/addons
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    networks:
      - smarttub-net
    devices:
      - /dev/ttyACM0:/dev/ttyACM0  # USB devices (if needed)
    # Uncomment for privileged mode (e.g., for USB devices)
    # privileged: true

# ============================================================================
# Networks
# ============================================================================
networks:
  smarttub-net:
    name: smarttub-network
    driver: bridge

# ============================================================================
# Volumes (optional - for named volumes instead of bind mounts)
# ============================================================================
# volumes:
#   mosquitto-data:
#   mosquitto-log:
#   smarttub-config:
#   smarttub-log:
#   openhab-conf:
#   openhab-userdata:
#   openhab-addons:
